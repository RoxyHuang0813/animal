from flask import Flask, render_template, request, session, redirect, url_for, make_response

import random
from waitress import serve

app = Flask(__name__)
app.secret_key = 'your_secure_key_123'  # 正式環境請用更複雜的金鑰

ANIMALS = {
    'squirrel': '松鼠型',
    'cheetah': '獵豹型',
    'owl': '貓頭鷹型',
    'raccoon': '浣熊型',
    'wolf': '狼型',
    'peacock': '孔雀型'
}


# 定義每種動物類型的隨機語錄
ANIMAL_QUOTES = {
    'squirrel': [
        "我存錢不是為了給你花的耶！",
        "我的存款比你的八卦還多！",
        "折扣再低，也比不上存款帶來的安全感！",
        "存錢才是快樂的來源，花錢只會讓我焦慮！",
        "你買快樂，我買未來！"
    ],
    'cheetah': [
        "我很大方，但不代表你可以佔我便宜！",
        "人生苦短，買了再說！",
        "沒花掉的錢，等於沒存在過！",
        "有賺有花，才是真正的享受人生！",
        "等我存夠錢？那機會早就溜走啦！"
    ],
    'owl': [
        "數據才是我的真愛，衝動？不存在的！",
        "沒有完美的計劃，我怎麼可能出手？",
        "沒有Excel，我怎麼知道這筆錢值不值得花？",
        "別人怕沒錢，我怕沒資訊！",
        "理財不是感覺，而是邏輯！"
    ],
    'raccoon': [
        "大家說好才是真的好，獨樂樂不如眾樂樂！",
        "朋友的推薦，比黃金還珍貴！",
        "沒有你陪，這錢花起來就沒靈魂！",
        "團購99折？我立刻揪團！",
        "比省錢更重要的，是一起花錢的快樂！"
    ],
    'wolf': [
        "帶領團隊衝鋒陷陣，財富自然滾滾來！",
        "我的策略，就是讓錢為我工作！",
        "沒有資源？整合起來就有了！",
        "投資不只是錢，還有關係、資訊和時機！",
        "財富不是偶然，是精心佈局的結果！"
    ],
    'peacock': [
        "品味，就是我的最佳投資！",
        "生活要有儀式感，錢包也要跟上！",
        "窮得只剩錢？我可不想這樣！",
        "錢不是問題，問題是怎麼花得漂亮！",
        "別問我為什麼買，因為值得！"
    ]
}


# 定義每種動物對應的大K老師對話
TEACHER_DIALOGUES = {
    'squirrel': '你是謹慎的松鼠型！喜歡儲備資源，適合穩健的理財方式。療癒小提示：「你的內在安全感，是否只能來自金錢？如果沒有存款，你會怎麼定義自己的價值？」催眠可以幫助你放下金錢焦慮，找到真正的內在安全感。',
    'cheetah': '你是敏捷的獵豹型！喜歡快速行動，適合高風險高報酬的投資。療癒小提示：「你的決策模式是否來自害怕錯過？這種焦慮感，可能與過去未完成的渴望有關。」催眠可以探索你的內在潛意識，培養穩定強大的內心。',
    'owl': '你是智慧的貓頭鷹型！喜歡分析數據，適合長期投資策略。療癒小提示：「你是否過度分析，以至於難以行動？這種控制欲，可能來自對犯錯的恐懼。」催眠可以協助你調整過度完美主義，學會信任自己的直覺。',
    'raccoon': '你是靈活的浣熊型！喜歡與人合作，適合團隊投資或合夥創業。療癒小提示：「你是否常常為了別人而做財務決策？你的金錢模式，是否來自想要被接納？」催眠可以幫助你建立自我價值，不再依賴外界認可。',
    'wolf': '你是領導的狼型！喜歡掌控全局，適合創業或管理大型專案。療癒小提示：「你是否把財富當作掌控人生的方式？如果不做領導者，你如何定義自己？」催眠可以讓你放下控制焦慮，讓財富流動更自由。',
    'peacock': '你是耀眼的孔雀型！喜歡展現自我，適合品牌經營或創意產業。療癒小提示：「你是否認為金錢能定義你的價值？如果沒有華麗外表時，你是否仍然感覺自己足夠好？」催眠可以協助你探索自我，讓財務選擇更加平衡。'
}


# 定義每種動物類型的故事
ANIMAL_STORIES = {
    'squirrel': '''
在一片寧靜的森林中，住著一隻名叫瑪莉的松鼠。
她的家位於一棵古老的橡樹上，四周被高高的樹木環繞，安全又安靜。
瑪莉總是為了未來做好準備，並且對每一分每一毫的資源都精打細算。
每到秋天，她就開始搜尋堅果，將它們小心翼翼地藏起來，以確保自己能度過漫長的冬天。

然而，隨著時間的推移，瑪莉發現自己愈加焦慮。
每當冬天快來時，她總是會擔心萬一有一天她的儲備不夠用，或者萬一她錯過了某個收集堅果的最佳時機。
這種焦慮不僅影響了她的睡眠，甚至讓她疏遠了身邊的朋友。

某天，瑪莉在整理堅果的時候，遇到了她的老朋友——一隻總是充滿笑容的小兔子，牠名叫比利。
比利看到瑪莉忙得不亦樂乎，便輕聲問道：「瑪莉，為什麼你總是這麼忙，從不輕鬆一下呢？」

瑪莉看了看比利，苦笑道：「我必須確保自己有足夠的食物過冬。
這樣才能保證安全，不會缺乏。」

比利聳了聳肩說：「可是你過度焦慮了呀。
生活不僅僅是為了積累資源，也需要和朋友們共享快樂。
或許你可以和我們一起去採摘一些新鮮的莓果，順便休息一下，也許這會讓你更有活力。」

瑪莉沉默了一會兒，心中充滿了掙扎。
她知道比利說的是對的，但她內心的恐懼讓她無法輕易放下那份焦慮。
最終，在比利的邀請下，瑪莉決定放下堅果，和朋友們一起去採摘莓果。
那天，她第一次真正感受到了放鬆，甚至笑了出來。

那晚，瑪莉躺在床上，感覺到一股久違的平靜。
她開始明白，儲蓄和計劃固然重要，但生活中的快樂和與朋友們的聯繫同樣不可忽視。
她對自己的未來不再過度擔心，而是學會了在積極準備的同時，也享受當下。

療癒提示： 當你過度專注於未來，可能會忽略眼前的美好。
學會適時放下焦慮，讓當下的快樂與安全感共存。
    ''',
    'cheetah': '''
在遼闊的草原上，雷納德總是以迅雷不及掩耳之勢行動。
他是一隻敏捷的獵豹，行動快速、果斷且直覺。
他總是覺得，機會稍縱即逝，錯過一秒鐘可能就錯過了成功。
因此，每當有新的機會出現，他總是第一時間抓住，無論是捕捉獵物還是投資生意，雷納德都會毫不猶豫地投入其中。

這樣的生活讓雷納德積累了不少成就，但也帶來了不少問題。
一次，雷納德聽聞遠處的山谷中有一片極為肥沃的土地，他立刻決定趕過去，準備在那裡進行投資。
他沒有仔細分析這片土地的情況，也沒有聽取過其他動物的意見，只是憑著直覺行動。
結果，他的投資失敗，損失了大量的資源。

當雷納德心情低落地回到家時，他的朋友——一隻年長的老鷹飛來，輕聲問道：「雷納德，為什麼這次的決策會如此急躁呢？」

雷納德沮喪地回答：「我總是怕錯過任何機會，甚至錯過了成功的瞬間。」

老鷹眨了眨眼，說道：「成功不僅僅是速度，還需要智慧。
有時候，思考的片刻會帶來比衝動行動更多的回報。
耐心和計劃，也是一種力量。」

雷納德愣了一會兒，然後點了點頭。
他意識到自己總是過於焦急，無法冷靜下來。
於是，他決定放慢腳步，學會聆聽他人的建議，也學會讓每一個決策都更加深思熟慮。

幾個月後，雷納德再次面對一個新的投資機會，這一次，他耐心地觀察，並且與朋友們討論，最終做出了成功的決策。

療癒提示： 衝動的決策可能帶來即時的回報，但耐心和深思熟慮的決策，往往能帶來長久的成功。
學會放慢腳步，給自己更多的時間來思考。
    ''',
    'owl': '''
艾德華是一隻極為聰明的貓頭鷹，他的生活總是充滿了計劃和邏輯。
他喜歡分析每一個細節，無論是獵物的分布還是金錢的流動，他都會通過數據來做出最優選擇。
這種分析的習慣使得艾德華幾乎不會犯錯，並且在森林中成為了眾所周知的財務和策略專家。

然而，這樣的完美主義讓艾德華的生活變得越來越壓力山大。
每當他面對任何重要的決策，他總是反覆推敲，力求達到最佳結果。
這樣的過程讓他很難下定決心，時常錯失了最佳的機會。

一天，艾德華的朋友，一隻幽默的小松鼠來到他面前，笑著說：「你每次都在分析這麼多東西，為什麼不試試直覺呢？
你知道的，過度分析只會讓你感到困惑。」

艾德華聽後，皺了皺眉，語氣認真地說：「可是，怎麼能不分析清楚呢？
只有做出最完美的決策，才能確保成功。」

小松鼠輕輕搖頭：「有時候，過度分析反而會讓你失去行動的勇氣。
你要學會信任自己，也要相信，錯誤有時候也能帶來學習的機會。」

艾德華陷入了沉思。
他決定開始放下那些過於細緻的分析，學會聆聽自己的內心。
在接下來的一段時間裡，他開始進行一些小的嘗試，讓直覺引導自己做決策，結果發現，這種方式竟然讓他感到更加自由和輕鬆。

療癒提示： 完美的決策不一定會帶來最好的結果。
學會接受不完美，並相信直覺能帶來意想不到的收穫。
    ''',
    'raccoon': '''
羅伯特是一隻熱愛社交的浣熊，他的日子總是充滿了忙碌和活動。
他有著無數的朋友，無論是森林中的狐狸、兔子，還是樹上生活的鳥兒，幾乎每個動物都和他保持著良好的聯繫。
羅伯特擅長與他人合作，並且對於群體的需求特別敏感。
這讓他總是能在團體中迅速站穩腳跟，並且獲得許多資源。

然而，這樣的依賴讓羅伯特也有了困擾。
他經常會為了迎合他人的需求，而忽略自己的想法，甚至有時會感到自己在做事時缺乏自主性。
最令人困擾的是，他經常無法拒絕他人，無論是朋友的借貸請求，還是社群中的共同投資，羅伯特總是會答應，儘管這樣的決定往往會讓他自己的財務狀況變得吃緊。

有一天，羅伯特在森林裡碰到了他的小時候的朋友——一隻成熟穩重的刺蝟。
刺蝟看到羅伯特忙得不亦樂乎，便走過來問道：「羅伯特，你怎麼這麼忙，總是為別人著想，自己卻看起來很疲憊？」

羅伯特苦笑著說：「我只想要大家開心，總是難以拒絕他們的請求。」

刺蝟搖了搖頭，語氣溫和地說：「你要記住，真正的關心是給自己一點空間，讓自己也能過得快樂。
當你總是為他人而活，最終會迷失自己的方向。」

羅伯特聽後陷入了沉思，終於明白，自己不該總是將他人的需求放在首位。
他開始學會拒絕不必要的請求，並且開始專注於自己真正的需求。
隨著時間的推移，羅伯特發現，他能夠更好地照顧自己，同時仍然保持良好的社交關係。
他學會了平衡自己和他人之間的關係，找到了屬於自己的獨立空間。

療癒提示： 幫助他人固然重要，但也要學會為自己設置界限，讓自己保持健康的平衡，才能更好地給予他人。
    ''',
    'wolf': '''
在森林的邊緣，有一隻名叫卡爾的狼，他是一位天生的領袖。
卡爾從小就擁有過人的智慧和強大的領導力，他總是能夠帶領著自己的狼群走出困境，並且在追逐獵物時總能夠快速做出正確的決策。
卡爾不僅是一位優秀的戰略家，還擅長整合資源，並且能夠把群體的力量發揮到極致。

然而，卡爾的領導風格也帶來了一些問題。
他常常專注於大局，忽略了身邊每個成員的需求。
這使得他的狼群雖然在外界的挑戰中屢屢獲勝，但內部卻漸漸出現了不和。
狼群的其他成員開始感到被忽視，他們對卡爾的決策產生了疑慮，並且開始感到疏遠。

有一天，卡爾遇到了年長的白鹿，白鹿是森林中的智者，常年生活在山林間，並且總是給人留下深刻的印象。
白鹿見到卡爾時，輕輕地說：「你似乎在努力維持著一個強大的領導地位，但你可曾發現，有時候真正的力量來自於關心和聆聽他人的心聲？」

卡爾低下頭，沉默了一會兒。
白鹿繼續說：「一個成功的領導者不僅僅是決策者，更是關懷者。
當你忽視個體的需求，群體的力量也會逐漸消耗。」

卡爾聽後開始深刻反思。
他回到狼群中，花更多的時間去了解每一位成員的心聲，並且鼓勵他們提出自己的想法。
這樣一來，狼群的內部關係得到了修復，大家的合作更加默契，也讓卡爾在領導上更加得心應手。

療癒提示： 一個強大的領袖不僅能夠做出決策，更能夠理解和關心每一位成員。
學會聆聽，能讓你成為真正的領導者。
    ''',
    'peacock': '''
費爾南多是一隻光鮮亮麗的孔雀，他的羽毛五彩斑斕，總是吸引著眾多動物的目光。
費爾南多極其重視自己的形象和社交圈，他認為，金錢不僅是用來滿足生活所需，還是用來展示自己的地位和身份。
他總是喜歡以最新的時尚和最豪華的物品來提升自己的社會形象，並且不吝嗇於在社交場合展示自己的財富。

然而，隨著時間的流逝，費爾南多漸漸發現，儘管他在社交場合總是受到關注和羨慕，但內心卻越來越空虛。
他發現自己無法真正享受這些奢華的物品，因為每一次購買背後，總是充滿了為了滿足他人眼光的壓力。
費爾南多開始懷疑，自己到底是否為了真正的快樂而消費，還是僅僅為了維持一個表面上的形象。

某一天，費爾南多在湖邊遇見了一隻老烏鴉，這隻烏鴉生活簡樸，卻從不缺少快樂。
費爾南多忍不住問道：「你從不追求華麗的東西，為什麼你總是那麼快樂？」

老烏鴉微笑著回答：「真正的快樂來自內心，而非外在的物品。
你以為金錢能帶來的快樂，是短暫的虛榮。
當你放下對他人評價的依賴，你會發現，自己才是最重要的。」

費爾南多聽後深受觸動，他決定改變自己對金錢的看法，開始將財富用來實現自己的內心需求，而非單純地展示外在的形象。
他發現，這樣的生活不僅讓他擁有更多的自由，也讓他重新找回了真正的快樂。

療癒提示： 物質的外在光鮮只是短暫的，真正的滿足來自於內心的平靜與自信。
學會放下他人的眼光，去追尋屬於自己的快樂。
    '''
}
# 新增故事頁面路由
@app.route('/story/<animal>')
def story(animal):
    story_content = ANIMAL_STORIES.get(animal, '沒有找到該動物的故事。')
    return render_template('story.html', story_content=story_content, animal_name=ANIMALS.get(animal, '未知動物'))

# 新增分享頁面路由
@app.route('/share')
def share():
    return render_template('share.html')

QUESTIONS = [
    {
        'question': '看到便利商店出了新的限量商品，你的第一反應是？',
        'options': [
            {'text': '還是要上網查怎樣才是C/P值最高', 'type': 'owl'},
            {'text': '只要我喜歡不用等打折，我現在就買!', 'type': 'cheetah'},
            {'text': '限量耶，好東西一定要買來跟好朋友分享', 'type': 'raccoon'},
            {'text': '說不定賣不完還會再打折，我再等等', 'type': 'squirrel'},
            {'text': '主管之前好像有提過，我先幫他買看他要不要，', 'type': 'wolf'},
            {'text': '昨天新聞有看到，好像很多人要搶，那還是買一下好了', 'type': 'peacock'}
        ]
    },
    {
        'question': '今年年終發了獎金10萬元，你會？',
        'options': [
            {'text': '先存起來，再想想要買什麼', 'type': 'squirrel'},
            {'text': '比特幣現在是低點，這筆錢買了一定翻倍', 'type': 'cheetah'},
            {'text': '我朋友說想吃教父牛排，發年終了我請他', 'type': 'raccoon'},
            {'text': '30%存起來/30%買東西/剩下40%買股票好了', 'type': 'owl'},
            {'text': '朋友想開店，要不然我拿這筆錢投資當股東好了', 'type': 'wolf'},
            {'text': '我的手機跟家裡冰箱可以換新了', 'type': 'peacock'}
        ]
    },
    {
        'question': '面對投資虧損，你的反應是？',
        'options': [
            {'text': '我以後再也不投資了', 'type': 'squirrel'},
            {'text': '應該趁低點加碼攤平才對', 'type': 'cheetah'},
            {'text': '我問一下銀行的朋友看看', 'type': 'raccoon'},
            {'text': '一定是我之前分析得不對，我再研究一下', 'type': 'owl'},
            {'text': '該賣就賣，當斷則斷', 'type': 'wolf'},
            {'text': '不想面對，先放著以後再說', 'type': 'peacock'}
        ]
    },
    {
        'question': '選擇理財商品時，你最重視？',
        'options': [
            {'text': '風險越低越好，定存我也能接受', 'type': 'squirrel'},
            {'text': '高風險高回報,賭賭看', 'type': 'cheetah'},
            {'text': '我朋友說那支會漲，可以買', 'type': 'raccoon'},
            {'text': '我先分析一下歷年的投報率再決定', 'type': 'owl'},
            {'text': '要能随時變現，像儲蓄險這種的我不買', 'type': 'wolf'},
            {'text': '投顧老師經驗豐富，我聽他的', 'type': 'peacock'}
        ]
    },
    {
        'question': '朋友向你借錢，你會？',
        'options': [
            {'text': '想辦法找理由拒絕', 'type': 'squirrel'},
            {'text': '就算親兄弟還是要算利息哦', 'type': 'cheetah'},
            {'text': '很為難，可能會勉強答應', 'type': 'raccoon'},
            {'text': '我可以借，但是一定要簽借據', 'type': 'owl'},
            {'text': '有什麼好康大家互相回饋一下也不是不行', 'type': 'wolf'},
            {'text': '態度好的求求我，我可以考慮', 'type': 'peacock'}
        ]
    },
    {
        'question': '你如何定義「財務自由」？',
        'options': [
            {'text': '我的存款夠用一輩子', 'type': 'squirrel'},
            {'text': '錢多到想要什麼就能買什麼', 'type': 'cheetah'},
            {'text': '錢只要夠用就好，家人朋友才是最重要的資產', 'type': 'raccoon'},
            {'text': '當然是被動收入>支出', 'type': 'owl'},
            {'text': '要有事業，沒有都是幫人打工哪來的自由', 'type': 'wolf'},
            {'text': '像貴婦那樣令人羨慕的生活才自由', 'type': 'peacock'}
        ]
    },
    {
        'question': '當你發現朋友的財務狀況比你好，你會？',
        'options': [
            {'text': '焦慮自己存款不足', 'type': 'squirrel'},
            {'text': '我也有機會賺大錢，不會輸他', 'type': 'cheetah'},
            {'text': '問問朋友怎麼做到的', 'type': 'raccoon'},
            {'text': '研究對方的投資策略並調整自己的計畫', 'type': 'owl'},
            {'text': '回去想想怎麼樣才能賺更多錢', 'type': 'wolf'},
            {'text': '錢就是要花在自己身上，存那麼多幹嘛', 'type': 'peacock'}
        ]
    },
    {
        'question': '你通常如何規劃一天的行程？',
        'options': [
            {'text': '每天都差不多，滿固定的', 'type': 'squirrel'},
            {'text': '不一定，看情況調整', 'type': 'cheetah'},
            {'text': '如果朋友揪我我都會去', 'type': 'raccoon'},
            {'text': '我有寫行事曆安排每一天的行程', 'type': 'owl'},
            {'text': '我的年度目標有達到就好，不會規劃到每一天', 'type': 'wolf'},
            {'text': '喜歡拓展社交圈，人多的地方都去', 'type': 'peacock'}
        ]
    },
    {
        'question': '面對財務壓力時，你的解決方式是？',
        'options': [
            {'text': '反覆計算存款還夠不夠', 'type': 'squirrel'},
            {'text': '壓力越大越愛亂買', 'type': 'cheetah'},
            {'text': '找朋友訴苦', 'type': 'raccoon'},
            {'text': '越分析越清楚，思考解決方法', 'type': 'owl'},
            {'text': '想辦法找別人合作，借力使力', 'type': 'wolf'},
            {'text': '先不管，轉移注意力', 'type': 'peacock'}
        ]
    },
    {
        'question': '當你聽到一種新的理財工具時，你的第一反應是？',
        'options': [
            {'text': '我只選保本型商品', 'type': 'squirrel'},
            {'text': '有趣，先買一點試試看', 'type': 'cheetah'},
            {'text': '跟家人朋友一起討論', 'type': 'raccoon'},
            {'text': '要做功課，詳細分析才知道好不好', 'type': 'owl'},
            {'text': '會先問一些專業人士的意見', 'type': 'wolf'},
            {'text': '如果有大銀行推薦應該沒問題', 'type': 'peacock'}
        ]
    },
    {
        'question': '感覺經濟衰退時，你的應對策略是？',
        'options': [
            {'text': '減少消費，節省到極限', 'type': 'squirrel'},
            {'text': '多買樂透看會不會中頭獎', 'type': 'cheetah'},
            {'text': '多跟朋友聊聊看他們的情況', 'type': 'raccoon'},
            {'text': '重新計算自已的資產看看會不會有風險', 'type': 'owl'},
            {'text': '就等這個機會買法拍屋，以後一定賺', 'type': 'wolf'},
            {'text': '跟平常一樣，又不一定會發生，', 'type': 'peacock'}
        ]
    },
    {
        'question': '計畫出國旅行時，你優先考慮？',
        'options': [
            {'text': '預算最重要，超出太多就不考慮了', 'type': 'squirrel'},
            {'text': '就說走就走，機票買了再說！', 'type': 'cheetah'},
            {'text': '一定要問朋友推薦，有人去過才不踩雷', 'type': 'raccoon'},
            {'text': '詳細比較機票、住宿、行程，出國也要精打細算。', 'type': 'owl'},
            {'text': '旅行能不能順便開拓人脈或找到商機', 'type': 'wolf'},
            {'text': '網美推薦的熱門景點，一定要住五星級飯店', 'type': 'peacock'}
        ]
    }
]

@app.route('/')
def index():
    session.clear()
    return render_template('index.html')

@app.route('/test', methods=['GET', 'POST'])
def test():
    if 'answers' not in session:
        session['answers'] = []
    
    if request.method == 'POST':
        selected_type = request.form.get('animal_type')
        session['answers'].append(selected_type)
        session.modified = True
    
    if len(session['answers']) >= len(QUESTIONS):
        return redirect('/result')
    
    current_q = QUESTIONS[len(session['answers'])]
    random.shuffle(current_q['options'])
    
    return render_template('test.html',
                         question=current_q['question'],
                         options=current_q['options'],
                         progress=len(session['answers'])+1,
                         total=len(QUESTIONS))

@app.route('/result')
def result():
    if 'answers' not in session or len(session['answers']) != len(QUESTIONS):
        return redirect(url_for('index'))

    counts = {}
    for animal in session['answers']:
        counts[animal] = counts.get(animal, 0) + 1
    result_type = max(counts, key=lambda k: counts[k])



    teacher_dialogue = TEACHER_DIALOGUES.get(result_type, '恭喜你完成測驗！快把專屬你的財富性格分享給朋友吧！')
    random_quote = random.choice(ANIMAL_QUOTES.get(result_type, ["歡迎來到潛意識財富森林！"]))


    response = make_response(render_template(
        'result.html',
        animal=result_type,
        animal_name=ANIMALS[result_type],

        teacher_dialogue=teacher_dialogue,
        random_quote=random_quote

    ))
    response.headers['Cache-Control'] = 'no-store, must-revalidate'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    return response

if __name__ == '__main__':
    app.run(debug=True)
